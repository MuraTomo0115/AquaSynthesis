using System.Collections;
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.SceneManagement;
using DG.Tweening;

public class Menu : MonoBehaviour
{
    [SerializeField] private GameObject      _menuContents;           // メニュー全体のUIオブジェクト
    [SerializeField] private GameObject      _menuUI;                 // メニューUIオブジェクト
    [SerializeField] private GameObject      _player;                 // プレイヤーオブジェクト
    private Animation                        _menuAnim;               // メニュー開閉用のAnimationコンポーネント
    private bool                             _isOpen = false;         // メニューが開いているかどうか

    [SerializeField] private RectTransform[] _menuItems;              // メニュー項目（ボタン等）の配列
    [SerializeField] private GameObject      _backButton;             // 戻るボタンのGameObject
    private int                              _currentIndex = 0;       // 現在選択中のメニュー項目インデックス
    private bool                             _isInCarousel = true;    // メニュー項目選択中か（true:メニュー項目, false:戻るボタン）
    private Outline                          _backButtonOutline;      // 戻るボタンのOutlineコンポーネント
    private Vector3                          _originalBackButtonScale;// 戻るボタンの元のスケール
    private Tween                            _outlineTween;           // Outline点滅用のDOTweenインスタンス
    private MenuInputActions                 _inputActions;           // 入力アクション管理用
    private Menu                             _menu;                   // メニュークラスのインスタンス
    private PlayerMovement _playerMovement;                           // プレイヤーの移動クラスのインスタンス

    private const float                      MenuItemSelectedScale = 1.2f;       // 選択中メニュー項目の拡大率
    private const float                      MenuItemTweenDuration = 0.2f;       // メニュー項目の拡大・縮小アニメーション時間
    private const float                      BackButtonTweenDuration = 0.2f;     // 戻るボタンの拡大・縮小アニメーション時間
    private const float                      StartAnimScale = 1.2f;              // 開始時の拡大率
    private const float                      StartAnimDuration = 0.4f;           // 開始時の拡大アニメーション時間
    private const float                      OutlineBlinkDuration = 0.5f;        // Outline点滅の周期
    private static readonly Color            OutlineDefaultColor = Color.yellow; // Outlineのデフォルト色
    private static readonly Color            OutlineBlinkColor = Color.white;    // Outline点滅時の色

    private void Awake()
    {
        _menuAnim = _menuUI.GetComponent<Animation>();
        _backButtonOutline = _backButton.GetComponent<Outline>();
        _backButtonOutline.enabled = false;
        _backButtonOutline.effectColor = OutlineDefaultColor;
        _originalBackButtonScale = _backButton.GetComponent<RectTransform>().localScale;

        _inputActions = new MenuInputActions();
        _inputActions.Menu.Move.performed += ctx => OnMove(ctx.ReadValue<Vector2>().x);
        _inputActions.Menu.Vertical.performed += ctx => OnVertical(ctx.ReadValue<Vector2>().y);
        _inputActions.Menu.Click.performed += ctx => OnClick();
        _inputActions.Menu.Scroll.performed += ctx => OnScroll(ctx.ReadValue<Vector2>().y);
    }

    /// <summary>
    /// 開始時にメニュー項目の選択状態を初期化
    /// </summary>
    private void Start()
    {
        UpdateSelection();

        // プレイヤーオブジェクトを取得
        _player = GameObject.FindGameObjectWithTag("Player");
        // プレイヤーの移動クラスを取得
        _playerMovement = _player.GetComponent<PlayerMovement>();
        // ステージシーンならMenuInputActionsアクションマップを有効化
        _inputActions.Menu.Enable();
        _inputActions.Menu.Open.performed += ctx => ToggleMenu();
    }

    /// <summary>
    /// メニューの開閉状態を切り替え
    /// </summary>
    public void ToggleMenu()
    {
        _menuContents.SetActive(true);

        if (_isOpen)
        {
            CloseMenu();

            // プレイヤーの移動を有効化
            _playerMovement.OnEnable();
        }
        else
        {
            // メニューを開く前にプレイヤーの移動を無効化
            _playerMovement.DisableInput();
            OpenMenu();
        }
    }

    /// <summary>
    /// メニューを開く処理
    /// </summary>
    private void OpenMenu()
    {
        ResetAnimationState();

        if (_menuAnim.clip != null)
            _menuAnim.Play();

        _menuUI.SetActive(true);
        GameManager.Instance.ChangeState(GameState.Menu);

        _isOpen = true;
        StartCoroutine(WaitForAnimationToEndAndPause());
    }

    /// <summary>
    /// メニューを閉じる処理
    /// </summary>
    private void CloseMenu()
    {
        _menuAnim.Stop();

        AnimationState stateMenu = _menuAnim[_menuAnim.clip.name];
        stateMenu.speed = -1f;
        stateMenu.time = stateMenu.length;
        _menuAnim.Play(_menuAnim.clip.name);

        StartCoroutine(WaitForAnimationToEndAndResume());
    }

    /// <summary>
    /// アニメーション終了後にTimeScaleを0にする
    /// </summary>
    private IEnumerator WaitForAnimationToEndAndPause()
    {
        yield return new WaitForSecondsRealtime(_menuAnim.clip.length);
        Time.timeScale = 0f;
    }

    /// <summary>
    /// アニメーション終了後にTimeScaleを1に戻す
    /// </summary>
    private IEnumerator WaitForAnimationToEndAndResume()
    {
        yield return new WaitForSecondsRealtime(_menuAnim.clip.length);
        _isOpen = false;
        Time.timeScale = 1f;
    }

    /// <summary>
    /// アニメーション状態をリセット
    /// </summary>
    private void ResetAnimationState()
    {
        AnimationState stateMenu = _menuAnim[_menuAnim.clip.name];
        stateMenu.time = 0f;
        stateMenu.speed = 1f;
    }

    /// <summary>
    /// 有効化時に入力アクションを有効にする
    /// </summary>
    private void OnEnable()
    {
        _inputActions.Menu.Enable();
    }

    /// <summary>
    /// 無効化時に入力アクションを無効にする
    /// </summary>
    private void OnDisable()
    {
        _inputActions.Menu.Disable();
    }

    /// <summary>
    /// 横方向の入力でメニュー項目を移動
    /// </summary>
    private void OnMove(float direction)
    {
        if (!_isInCarousel) return;

        if (direction > 0) MoveRight();
        else if (direction < 0) MoveLeft();
    }

    /// <summary>
    /// 縦方向の入力でカーソル位置を切り替え
    /// </summary>
    private void OnVertical(float direction)
    {
        var rect = _backButton.GetComponent<RectTransform>();

        if (direction < 0 && _isInCarousel)
        {
            _isInCarousel = false;
            _backButton.GetComponent<Button>().Select();

            rect.DOScale(Vector3.one * MenuItemSelectedScale, BackButtonTweenDuration)
                .SetEase(Ease.OutBack)
                .SetUpdate(true);

            _backButtonOutline.enabled = true;
            StartOutlineBlink();
            UpdateSelection();
        }
        else if (direction > 0 && !_isInCarousel)
        {
            _isInCarousel = true;

            rect.DOScale(_originalBackButtonScale, BackButtonTweenDuration)
                .SetEase(Ease.OutBack)
                .SetUpdate(true);

            UpdateSelection();
            StopOutlineBlink();
            _backButtonOutline.enabled = false;
        }
    }

    /// <summary>
    /// 戻るボタンのOutlineを点滅させるアニメーションを開始
    /// </summary>
    private void StartOutlineBlink()
    {
        _outlineTween?.Kill();

        _outlineTween = DOTween.To(
            () => _backButtonOutline.effectColor,
            c => _backButtonOutline.effectColor = c,
            OutlineBlinkColor,
            OutlineBlinkDuration
        )
        .SetLoops(-1, LoopType.Yoyo)
        .SetEase(Ease.InOutSine)
        .SetUpdate(true);
    }

    /// <summary>
    /// 戻るボタンのOutline点滅アニメーションを停止し色を元に戻す
    /// </summary>
    private void StopOutlineBlink()
    {
        _outlineTween?.Kill();
        _backButtonOutline.effectColor = OutlineDefaultColor;
    }

    /// <summary>
    /// 決定ボタンが押されたときの処理
    /// </summary>
    private void OnClick()
    {
        if(!_isOpen) return;

        if (_isInCarousel)
        {
            Debug.Log("選択：" + _menuItems[_currentIndex].name);
        }
        else
        {
            Debug.Log("ゲームへ戻るボタン押下");
        }
    }

    /// <summary>
    /// スクロール入力でメニュー項目を移動
    /// </summary>
    private void OnScroll(float scroll)
    {
        if (!_isInCarousel) return;

        if (scroll > 0) MoveLeft();
        else if (scroll < 0) MoveRight();
    }

    /// <summary>
    /// メニュー項目を右に移動（ループあり）
    /// </summary>
    private void MoveRight()
    {
        if (_menuItems.Length == 0) return;
        _currentIndex = (_currentIndex + 1) % _menuItems.Length;
        UpdateSelection();
    }

    /// <summary>
    /// メニュー項目を左に移動（ループあり）
    /// </summary>
    private void MoveLeft()
    {
        if (_menuItems.Length == 0) return;
        _currentIndex = (_currentIndex - 1 + _menuItems.Length) % _menuItems.Length;
        UpdateSelection();
    }

    /// <summary>
    /// メニュー項目の選択状態に応じて拡大・縮小アニメーションを行う
    /// </summary>
    private void UpdateSelection()
    {
        for (int i = 0; i < _menuItems.Length; i++)
        {
            Vector3 targetScale = (_isInCarousel && i == _currentIndex) ? Vector3.one * MenuItemSelectedScale : Vector3.one;
            _menuItems[i].DOScale(targetScale, MenuItemTweenDuration)
                .SetEase(Ease.OutBack)
                .SetUpdate(true);
        }
    }
}